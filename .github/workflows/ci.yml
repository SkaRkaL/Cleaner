name: Bash CI Pipeline

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  test-cleaner:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout your repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Force a failure when commit message contains [fail]
      - name: Force failure on [fail]
        if: contains(github.event.head_commit.message, '[fail]')
        run: |
          echo "‚ùå Failing intentionally because commit message contains [fail]"
          exit 1

      # 3Ô∏è‚É£ Validate syntax of all shell scripts
      - name: Check Bash syntax
        run: |
          echo "üîç Checking syntax for all .sh files..."
          find . -type f -name "*.sh" -exec bash -n {} \;

      # 4Ô∏è‚É£ Run Cleaner.sh safely (smoke test)
      - name: Run Cleaner.sh (dry run)
        run: |
          echo "‚öôÔ∏è Testing Cleaner.sh..."
          chmod +x ./Cleaner.sh
          ./Cleaner.sh --help || true

      # 5Ô∏è‚É£ Verify help output (this one will fail if missing 'Usage:')
      - name: Verify help text
        run: |
          echo "üß™ Checking help output for 'Usage:' keyword..."
          out="$(./Cleaner.sh --help || true)"
          echo "$out"
          echo "$out" | grep -q "Usage:" || { echo "‚ùå Expected 'Usage:' in help output"; exit 1; }

      # 6Ô∏è‚É£ Always upload workspace files (useful for debugging)
      - name: Upload workspace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cleaner-workspace
          path: ./
